{{ $secret := (lookup "v1" "Secret" .Release.Namespace (include "matrix-synapse.fullname" .)) -}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "matrix-synapse.fullname" . }}
  labels:
    {{- include "matrix-synapse.labels" . | nindent 4 }}
data:
  {{- if .Values.config.recaptcha }}
  RECAPTCHA_PRIVATE_KEY: {{ .Values.config.recaptcha.privateKey | b64enc }}
  {{- end }}
  {{- if .Values.config.turnSecret }}
  TURN_SHARED_SECRET: {{ .Values.config.turnSecret | b64enc }}
  {{- end }}
  {{- if .Values.config.registrationSharedSecret }}
  REGISTRATION_SHARED_SECRET: {{ .Values.config.registrationSharedSecret | b64enc }}
  {{- else }}
  {{-   if $secret }}
  REGISTRATION_SHARED_SECRET: {{ (b64dec $secret.data.REGISTRATION_SHARED_SECRET) | default (randAlphaNum 24) | b64enc }}
  {{-   else }}
  REGISTRATION_SHARED_SECRET: {{ randAlphaNum 24 | b64enc }}
  {{-   end }}
  {{- end }}
  {{- if .Values.config.macaroonSecretKey }}
  MACAROON_SECRET_KEY: {{ .Values.config.macaroonSecretKey | quote }}
  {{- end }}
  {{- $postgresPass := include "matrix-synapse.postgresql.password" . }}
  {{- if and $postgresPass (not .Values.postgresql.auth.existingSecret) }}
  POSTGRES_PASSWORD: {{ $postgresPass | b64enc }}
  {{- end }}
  {{- $redisPass := include "matrix-synapse.redis.password" . }}
  {{- if and $redisPass (not .Values.redis.auth.existingSecret) }}
  REDIS_PASSWORD: {{ $redisPass | b64enc }}
  {{- end}}
  {{- range $key, $value := .Values.extraSecretEnv }}
  {{ $key }}: {{ $value | toString | b64enc }}
  {{- end }}
